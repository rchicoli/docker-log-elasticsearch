language: go
go:
  - 1.9.2

services:
  - docker

sudo: required

before_install:
  - docker version

cache:
  directories:
    - ${TRAVIS_BUILD_DIR}/vendor/github.com
    - ${TRAVIS_BUILD_DIR}/vendor/golang.org
    - ${TRAVIS_BUILD_DIR}/vendor/gopkg.in

script:
  - sudo make integration_tests || exit 1
  - sudo make acceptance_tests || exit 1

stages:
  - name: build
    if: branch = development
  - name: test
    if: branch = development
  - name: release
    if: branch = master

matrix:
  include:
    - stage: build
      if: type IN (pull_request)
      script:
        - govendor sync +external
        - make

    - stage: test
      if: type IN (pull_request)
      env: CLIENT_VERSION=1

    - env: CLIENT_VERSION=2
      if: type IN (pull_request)

    - env: CLIENT_VERSION=5
      if: type IN (pull_request)

    - env: CLIENT_VERSION=6
      if: type IN (pull_request)

    - stage: release
      if: type IN (push)
      script:
        - ./scripts/git-release.sh
      deploy:
        provider: releases
        api_key: $GITHUB_TOKEN
        on:
          branch: master

after_install:
  - docker plugin ls